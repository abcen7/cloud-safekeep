name: CI & CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ‚öíÔ∏è Cloning repository
        uses: actions/checkout@v2

      - name: üß™ Install dependencies
        run: npm install

      - name: üß™ Lint Test
        run: npm run lint

      - name: üß™ Build Test
        run: npm run build
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚öíÔ∏è Cloning repository ...
        uses: actions/checkout@v2

      - name: üëã Authorization on server ...
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_SERVER_IP }} # VPS IP
          username: ${{ secrets.SSH_SERVER_USERNAME }} # VPS USERNAME
          key: ${{ secrets.SSH_PRIVATE_KEY }} # VPS SSH KEY
          script: whoami

      - name: ‚ö°Ô∏è Pulling updates ...
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_SERVER_IP }} # VPS IP
          username: ${{ secrets.SSH_SERVER_USERNAME }} # VPS USERNAME
          key: ${{ secrets.SSH_PRIVATE_KEY }} # VPS SSH KEY
          script: |
            whoami
            cd ${{ secrets.DEPLOY_PATH }}
            git pull

      - name: üß™ Stopping and recreating containers ...
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_SERVER_IP }} # VPS IP
          username: ${{ secrets.SSH_SERVER_USERNAME }} # VPS USERNAME
          key: ${{ secrets.SSH_PRIVATE_KEY }} # VPS SSH KEY
          script: |
            whoami
            docker-compose up -d

      - name: ‚ö°Ô∏è Building ...
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_SERVER_IP }} # VPS IP
          username: ${{ secrets.SSH_SERVER_USERNAME }} # VPS USERNAME
          key: ${{ secrets.SSH_PRIVATE_KEY }} # VPS SSH KEY
          script: |
            whoami
            docker-compose up